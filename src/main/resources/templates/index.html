<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Quartz</title>

    <script type="text/javascript" src="/js/jquery-1.12.4.min.js"></script>
    <link href="/bootstrap-3.3.7-dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="/bootstrap-3.3.7-dist/js/bootstrap.min.js"></script>

    <link href="/metisMenu/metisMenu.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="/dist/css/sb-admin-2.css" rel="stylesheet">
    <!-- Morris Charts CSS -->
    <link href="/morrisjs/morris.css" rel="stylesheet">
    <!-- Custom Fonts -->
    <link href="/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <script src="/metisMenu/metisMenu.min.js"></script>
    <!-- Morris Charts JavaScript -->
    <script src="/raphael/raphael.min.js"></script>

    <script src="/dist/js/sb-admin-2.js"></script>
</head>
<body>

<div id="wrapper">

    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-static-top" role="navigation" style="margin-bottom: 0">
        <div class="navbar-header">
            <!--<button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar">2</span>
                <span class="icon-bar">3</span>
                <span class="icon-bar">4</span>
            </button>-->
            <h5 class="navbar-brand">Quartz</h5>
        </div>


        <div class="navbar-header" style="float:right">
            <div class="breadcrumb" style="padding: 10px 35px;">
                <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#AddModal">添加</button>
            </div>
        </div>

        <div class="navbar-default sidebar" role="navigation">
            <div class="sidebar-nav navbar-collapse">
                <ul class="nav" id="side-menu">
                    <li class="sidebar-search">
                        <div class="input-group custom-search-form">
                            <input type="text" class="form-control" placeholder="Search...">
                            <span class="input-group-btn">
                                <button class="btn btn-default" type="button">
                                    <i class="fa fa-search"></i>
                                </button>
                            </span>
                        </div>
                        <!-- /input-group -->
                    </li>
                    <li>
                        <a href="#"><i class="fa fa-dashboard fa-fw"></i> 首页</a>
                    </li>
                    <li>
                        <a href="#"><i class="fa fa-bar-chart-o fa-fw"></i> Charts<!--<span class="fa arrow"></span>-->
                        </a>
                    </li>
                    <li>
                        <a href="#"><i class="fa fa-table fa-fw"></i> Tables</a>
                    </li>
                    <li>
                        <a href="#"><i class="fa fa-edit fa-fw"></i> Forms</a>
                    </li>
                    <li>
                        <a href="#"><i class="fa fa-wrench fa-fw"></i> UI Elements</a>

                    </li>
                    <li>
                        <a href="#"><i class="fa fa-sitemap fa-fw"></i> Multi-Level Dropdown></a>
                        <!--<ul class="nav nav-second-level">
                            <li>
                                <a href="#">Second Level Item</a>
                            </li>
                            <li>
                                <a href="#">Second Level Item</a>
                            </li>
                        </ul>-->
                    </li>

                </ul>
            </div>
            <!-- /.sidebar-collapse -->
        </div>
        <!-- /.navbar-static-side -->
    </nav>


    <div id="page-wrapper">


        <div class="row">
            <div class="panel-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover table-striped">
                        <thead>
                        <tr>
                            <th>任务名</th>
                            <th>执行类</th>
                            <th>触发器表达式</th>
                            <th>描述</th>
                            <th>下次执行时间</th>
                            <th>状态</th>
                            <th>编辑</th>
                        </tr>
                        </thead>
                        <tbody>


                        <!-- <tr>
                             <td class="text-center">天天美食</td>
                             <td class="text-center">TTMeiShiTask</td>
                             <td class="text-center">0 0 * * *</td>
                             <td class="text-center">美食思考的就是快点结束肯德基</td>
                             <td class="text-center">13:08:41</td>
                             <td class="text-center"><h5><a href="#"><span class="label label-success"
                                                                           style="color: green">正常</span></a></h5></td>
                             <td class="text-center">
                                 <button type="button" class="btn btn-primary" data-toggle="modal"
                                         data-target="#addTags">编辑
                                 </button>
                                 <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#delete">
                                     删除
                                 </button>
                             </td>
                         </tr>-->

                        </tbody>
                    </table>
                </div>

            </div>

        </div>

    </div>

</div>


<div class="modal fade " id="AddModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content" style="width: 700px;height: auto;">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">定时任务</h4>
            </div>
            <div class="modal-body">
                <form class="form-horizontal">
                    <div class="form-group">
                        <label class="col-sm-2 control-label">任务名</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" name="jobName"
                                   placeholder="例：任务名">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">组名</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" name="jobGroup"
                                   placeholder="例：任务组">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">执行类</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" name="jobClazz"
                                   placeholder="例：com.example.webmagic.NeeqNoticeTask">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">Trigger</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" name="cronExpression"
                                   placeholder="例：0 0 * * * ?">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">简介</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" name="desc"
                                   placeholder="例：定时任务每天定时爬">
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-offset-2 col-sm-10">
                            <button type="submit" name="submit" id="submit" class="btn btn-primary">提交</button>
                        </div>
                    </div>

                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade " id="updateModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content" style="width: 700px;height: auto;">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">定时任务</h4>
            </div>
            <div class="modal-body">
                <form class="form-horizontal">
                    <div class="form-group">
                        <label class="col-sm-2 control-label">任务名</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" name="jobName" id="jobName"
                                   placeholder="例：任务名" readonly="false">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">组名</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" name="jobGroup" id="jobGroup"
                                   placeholder="例：任务组" readonly="false">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">执行类</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" name="jobClazz" id="jobClazz"
                                   placeholder="例：com.example.webmagic.NeeqNoticeTask">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">Trigger</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" name="cronExpression" id="cronExpression"
                                   placeholder="例：0 0 * * * ?">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">简介</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" name="desc" id="desc"
                                   placeholder="例：定时任务每天定时爬">
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-offset-2 col-sm-10">
                            <button type="button"  id="update" class="btn btn-primary">提交</button>
                        </div>
                    </div>

                </form>
            </div>
        </div>
    </div>
</div>
<script language="javaScript">
    /*<![CDATA[*/

    $("#submit").click(function () {
        /*    $("input").each(function(){
                if($(this).val()== ""){
                    var str="?"+$(this).parent().prev().text()+"不能为空！\r\n";
                    alert(str);
                    form0.sno.style.background = '#FF0033';
                    this.select();
                    this.focus();
                    return ;
                }
            });*/
        document.forms[0].action = "/addJob";
        document.forms[0].method = "post";
        document.forms[0].submit();
    });

    getList();

    function getList() {
        $.ajax({
            type: 'GET',
            url: '/taskList',
            dataType: 'json',
            success: function (result) {
                getPage(result);

            }
        });
    }


    function getPage(result) {
        $.each(result.extend.jobList, function (i, item) {
            var col = getColor(item.jobStatus);
            var sta = setStatud(item);
            var d = "/removeJob?jobName=" + item.jobName + "&&jobGroup=" + item.jobGroup;

            var html = "";
            html += "<tr>";
            html += "<td class=\"text-center\">" + item.jobName + "</td>";
            html += "<td class=\"text-center\">" + item.jobClazz + "</td>";
            html += "<td class=\"text-center\">" + item.cronExpression + "</td>";
            html += "<td class=\"text-center\">" + item.desc + "</td>";
            html += "<td class=\"text-center\">" + item.nextFireTime + "</td>";
            html += "<td class=\"text-center\"><h5><a href=\"" + sta + "\"><span class=\"label label-" + col + "\">" + item.jobStatus + "</span></a></h5></td>";
            html += "<td class=\"text-center\"><button  type=\"button\" class=\"btn btn-primary update_btn\" data-group=\""+item.jobGroup+"\"  data-toggle=\"modal\">编辑</button>  ";
            /*data-target="#updateModal"*/
            html += "<a href=\"" + d + "\" type=\"button\" class=\"btn btn-danger\" data-toggle=\"modal\" > 删除</a>";
            /*data-target="#delete"*/
            html += "</td>";
            html += "</tr>";
            $("#wrapper").find("tbody").append(html);
        });
    }

    function getColor(stastus) {
        if (stastus == "正常") {
            return "success";
        } else if (stastus == "暂停") {
            return "danger";
        } else {
            return "warning";
        }
    }

    function setStatud(item) {
        var stastus = item.jobStatus
        if (stastus == "正常") {
            return "/pauseJob?jobName=" + item.jobName + "&&jobGroup=" + item.jobGroup + "";
        } else if (stastus == "暂停") {
            return "/resumeJob?jobName=" + item.jobName + "&&jobGroup=" + item.jobGroup + "";
        } else {
            return "/resumeJob?jobName=" + item.jobName + "&&jobGroup=" + item.jobGroup + "";
        }
    }


    $(document).on("click", ".update_btn", function () {
        var tr = $(this).parent().parent();
        var tds = tr.children();
        var name = tds.eq(0).text();
        var clazz =tds.eq(1).text();
        var cron =tds.eq(2).text();
        var desc =tds.eq(3).text();
        var group = $(this).attr("data-group");
        update(name,clazz,group,cron,desc);
        $("#updateModal").modal({
            backdrop: "static"
        });
    });


    /*回显*/
    function update(name,clazz,group,cron,desc) {
        // Getting URL var by its nam
        document.getElementById("jobName").value = name;
        document.getElementById("jobGroup").value = group;
        document.getElementById("jobClazz").value = clazz;
        document.getElementById("cronExpression").value = cron;
        document.getElementById("desc").value = desc;
    }


    $("#update").click(function () {
        $.ajax({
            url: "/editJob",
            type: "POST",
            data: $("#updateModal form").serialize(),
            success: function (result) {
                $("#updateModal").modal("hide");
                $("#wrapper").append("<p>"+result.msg+"</p>")
            }
        });

    });





    /*]]>*/

</script>
</body>
</html>